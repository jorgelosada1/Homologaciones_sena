{% extends "layout.html" %}
{% block content %}

<h2>ðŸ’° Precios Pregrado 2026</h2>

<!-- ===== CONTROLES ===== -->
<div class="top-bar">
    <input
        type="text"
        id="buscador"
        placeholder="ðŸ” Buscar programa..."
        oninput="filtrarProgramas()"
    >
    <button onclick="cambiarVista()">Cambiar vista</button>
</div>

<!-- ===== GRID / CARDS ===== -->
<div id="grid" class="grid">
    {% for p in programas %}
    <div class="card"
         data-nombre="{{ p.programa | lower }}"
         data-valor="{{ p.valor }}">

        <h3 title="{{ p.programa }}">{{ p.programa }}</h3>

        <div class="fila">
            <span>Base</span>
            <strong>$ {{ "{:,}".format(p.valor) }}</strong>
        </div>

        <div class="fila">
            <span>Desc %</span>
            <input type="number"
                   value="{{ p.descuento }}"
                   min="0" max="100"
                   oninput="recalcularCard(this)">
        </div>

        <div class="fila ahorro">
            <span>Ahorro</span>
            <strong>$0</strong>
        </div>

        <div class="final">$0</div>

        <button class="btn-info" onclick="abrirModal(this)">
            Ver oferta
        </button>
    </div>
    {% endfor %}
</div>

<!-- ===== TABLA ===== -->
<table id="tabla" class="tabla" style="display:none">
    <thead>
        <tr>
            <th>Programa</th>
            <th>Valor</th>
            <th>%</th>
            <th>Ahorro</th>
            <th>Final</th>
        </tr>
    </thead>
    <tbody>
        {% for p in programas %}
        <tr data-nombre="{{ p.programa | lower }}"
            data-valor="{{ p.valor }}">
            <td>{{ p.programa }}</td>
            <td>$ {{ "{:,}".format(p.valor) }}</td>
            <td>
                <input type="number"
                       value="{{ p.descuento }}"
                       min="0" max="100"
                       oninput="recalcularFila(this)">
            </td>
            <td class="ahorro">$0</td>
            <td class="final">$0</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ===== MODAL ===== -->
<div id="modal" class="modal" onclick="cerrarModal(event)">
    <div class="modal-box">
        <h3>ðŸŽ“ Oferta Universidad Areandina</h3>

        <!-- TEXTO VISIBLE -->
        <pre id="modal-texto" style="white-space:pre-wrap;font-family:inherit"></pre>

        <button class="btn-copiar" onclick="copiarOferta()">ðŸ“‹ Copiar para WhatsApp</button>
        <button onclick="cerrarModal()">Cerrar</button>
    </div>
</div>

<script>
let modo = 0; // 0=cards, 1=compacta, 2=tabla

function cambiarVista() {
    modo = (modo + 1) % 3;

    document.getElementById("grid").style.display =
        modo === 2 ? "none" : "grid";

    document.getElementById("tabla").style.display =
        modo === 2 ? "table" : "none";

    document.getElementById("grid")
        .classList.toggle("compacta", modo === 1);
}

function recalcularCard(input) {
    const card = input.closest(".card");
    const valor = parseInt(card.dataset.valor);
    const d = parseInt(input.value || 0);

    const ahorro = Math.round(valor * d / 100);
    const final = valor - ahorro;

    card.querySelector(".ahorro strong").innerText =
        "$ " + ahorro.toLocaleString();

    card.querySelector(".final").innerText =
        "$ " + final.toLocaleString();
}

function recalcularFila(input) {
    const row = input.closest("tr");
    const valor = parseInt(row.dataset.valor);
    const d = parseInt(input.value || 0);

    const ahorro = Math.round(valor * d / 100);
    const final = valor - ahorro;

    row.querySelector(".ahorro").innerText =
        "$ " + ahorro.toLocaleString();

    row.querySelector(".final").innerText =
        "$ " + final.toLocaleString();
}

function filtrarProgramas() {
    const q = document.getElementById("buscador").value.toLowerCase();

    document.querySelectorAll(".card, .tabla tbody tr")
        .forEach(el => {
            el.style.display =
                el.dataset.nombre.includes(q) ? "" : "none";
        });
}

function abrirModal(btn) {
    const card = btn.closest(".card");
    const nombre = card.querySelector("h3").innerText;
    const valor = parseInt(card.dataset.valor);
    const d = parseInt(card.querySelector("input").value || 0);

    const ahorro = Math.round(valor * d / 100);
    const final = valor - ahorro;

    const texto = 
`ðŸŽ“ Oferta Universidad Areandina
*${nombre}* en la *Universidad Areandina* tiene un valor regular de *$${valor.toLocaleString()}*.

Actualmente cuentas con un *${d}% de descuento*, lo que representa un ahorro de *$${ahorro.toLocaleString()}*.

âœ… El valor final de tu matrÃ­cula queda en *$${final.toLocaleString()}*.

ðŸ“Œ Cupos limitados. Aprovecha este beneficio exclusivo.`;

    document.getElementById("modal-texto").innerText = texto;
    document.getElementById("modal").style.display = "flex";
}

function copiarOferta() {
    const texto = document.getElementById("modal-texto").innerText;
    navigator.clipboard.writeText(texto);
}

function cerrarModal(e) {
    if (!e || e.target.id === "modal") {
        document.getElementById("modal").style.display = "none";
    }
}

// inicializar
document.querySelectorAll(".card input").forEach(i => recalcularCard(i));
document.querySelectorAll(".tabla input").forEach(i => recalcularFila(i));
</script>

<style>
/* ===== TOP BAR ===== */
.top-bar {
    position: sticky;
    top: 0;
    background: #f1f5f9;
    z-index: 10;
    padding: 8px 0 12px;
    display: flex;
    gap: 12px;
}

.top-bar input {
    flex: 1;
    max-width: 420px;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #cbd5f5;
    font-size: 13px;
}

.top-bar button {
    padding: 10px 14px;
    font-size: 13px;
}

/* ===== GRID ===== */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
    gap: 12px;
}

.grid.compacta {
    grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
}

/* ===== CARD ===== */
.card {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 5px 12px rgba(0,0,0,.06);
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 210px;
}

.card h3 {
    font-size: 13px;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.fila {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
}

.fila input {
    width: 50px;
    padding: 4px;
    text-align: center;
}

.ahorro {
    color: #16a34a;
}

.final {
    padding: 6px;
    background: linear-gradient(90deg,#2ecb0f,#27b80d);
    color: #fff;
    text-align: center;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
}

.btn-info {
    margin-top: auto;
    padding: 8px;
    border-radius: 8px;
    border: none;
    background: #2563eb;
    color: #fff;
    font-size: 12px;
    cursor: pointer;
}

.btn-info:hover {
    background: #1e40af;
}

/* ===== TABLA ===== */
.tabla {
    width: 100%;
    border-collapse: collapse;
    margin-top: 6px;
    font-size: 12px;
}

.tabla th, .tabla td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
}

.tabla input {
    width: 40px;
    text-align: center;
    font-size: 12px;
}

/* ===== MODAL ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.modal-box {
    background: #fff;
    max-width: 420px;
    width: 90%;
    padding: 20px;
    border-radius: 14px;
}

.modal-box button {
    margin-top: 10px;
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    background: #16a34a;
    color: #fff;
    font-weight: 600;
}

.btn-copiar {
    background: #2563eb;
}
</style>

{% endblock %}
